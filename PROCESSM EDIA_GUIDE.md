# ๐ฆ ุฏููู ProcessMediaFile.php - ูุชุทูุจุงุช ูุฅุนุฏุงุฏุงุช

## โ **ุงูุขู ูุญุณูู! ูุนูู ูู:**

- โ ุงูุชุทููุฑ (Windows/Mac/Linux)
- โ ุงูุฅูุชุงุฌ (Hostinger/ุฃู ุงุณุชุถุงูุฉ)
- โ ูุน FFmpeg (ุถุบุท ุชููุงุฆู)
- โ ุจุฏูู FFmpeg (ูุนูู ุนุงุฏู)

---

## ๐ ุงููุชุทูุจุงุช

### **1. Queue Tables (ุถุฑูุฑู)**

```bash
# ูุฑุฉ ูุงุญุฏุฉ ููุท
php artisan queue:table
php artisan queue:failed-table
php artisan migrate
```

### **2. Queue Driver ูู `.env`**

```env
QUEUE_CONNECTION=database
```

### **3. Composer Package (ููุถุบุท ููุท - ุงุฎุชูุงุฑู)**

```bash
composer require php-ffmpeg/php-ffmpeg
```

**ููุงุญุธุฉ:** ุฅุฐุง ูุง ุญููุชูุ ุงูู Job ูุดุชุบู ุนุงุฏู ุจุฏูู ุถุบุท

### **4. FFmpeg ุนูู ุงูุณูุฑูุฑ (ููุถุบุท ููุท - ุงุฎุชูุงุฑู)**

#### **Windows (Laragon):**

1. ุญููู ูู: https://ffmpeg.org/download.html
2. ูู ุงูุถุบุท ูู: `C:\ffmpeg\`
3. ุฃุถู ููู PATH

#### **Linux/Hostinger:**

```bash
# ุชุญูู ุฅุฐุง ููุฌูุฏ
which ffmpeg

# ุฅุฐุง ุบูุฑ ููุฌูุฏุ ุงุทูุจ ูู ุงูุฏุนู ุชุซุจูุชู
```

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### **ุงูุณููุงุฑูู 1: ุจุฏูู Queue (ุงูุญุงูู)**

ุงููููุงุช ุชูุฑูุน ุนุงุฏูุ Progress Bar ูุนูู โ

### **ุงูุณููุงุฑูู 2: ูุน Queue (ุจุฏูู ุถุบุท)**

#### **1. ุญุฏูุซ `.env`:**

```env
QUEUE_CONNECTION=database
```

#### **2. ุฃูุดุฆ ุงูุฌุฏุงูู:**

```bash
php artisan queue:table
php artisan migrate
```

#### **3. ุดุบูู Worker:**

##### **ุงูุชุทููุฑ (Laragon):**

```bash
php artisan queue:work --timeout=3600
```

##### **ุงูุฅูุชุงุฌ (Hostinger) - Cron Job:**

```
* * * * * cd /home/u123456789/domains/yoursite.com/public_html && /usr/bin/php artisan queue:work --stop-when-empty --timeout=600 > /dev/null 2>&1
```

#### **4. ุงุณุชุฎุฏู ูู Controller:**

ูู `PostController.php` (ุจุนุฏ ุญูุธ ุงูููู):

```php
// ุจุนุฏ ุฑูุน ุงูููุฏูู
if ($request->hasFile('video') && $videoPath) {
    // ุฅุฑุณุงู ููู Queue (ุจุฏูู ุถุบุท)
    \App\Jobs\ProcessMediaFile::dispatch(
        $post->id,
        $videoPath,
        'video',
        false  // โ false = ูุง ุชุถุบุท
    );
}
```

**ุงููุชูุฌุฉ:**

- ุงููุณุชุฎุฏู ูุฑูุน โ ูุฑู Progress Bar
- ุงูุฑูุน ููุชูู โ ูุฑูุญ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
- Job ูุดุชุบู ูู ุงูุฎูููุฉ (ููู ูุง ูุณูู ุถุบุท)

### **ุงูุณููุงุฑูู 3: ูุน Queue + ุถุบุท**

#### **1. ุซุจูุช FFmpeg Package:**

```bash
composer require php-ffmpeg/php-ffmpeg
```

#### **2. ุชุฃูุฏ ูู FFmpeg ุนูู ุงูุณูุฑูุฑ:**

```bash
# Windows
ffmpeg -version

# Linux
which ffmpeg
```

#### **3. ุงุณุชุฎุฏู ูู Controller:**

```php
if ($request->hasFile('video') && $videoPath) {
    // ุฅุฑุณุงู ููู Queue (ูุน ุถุบุท)
    \App\Jobs\ProcessMediaFile::dispatch(
        $post->id,
        $videoPath,
        'video',
        true  // โ true = ุงุถุบุท ุงูููู
    );
}
```

**ุงููุชูุฌุฉ:**

- ุงููุณุชุฎุฏู ูุฑูุน 400MB
- Progress Bar ููุชูู
- ูู ุงูุฎูููุฉ: FFmpeg ูุถุบุท โ 400MB ุชุตูุฑ 80MB
- ุงูููู ุงููุถุบูุท ูุญู ูุญู ุงูุฃุตูู

---

## ๐ง ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ

### **ุชุบููุฑ ุฌูุฏุฉ ุงูุถุบุท:**

ูู `ProcessMediaFile.php` (ุงูุณุทุฑ 151):

```php
// ููููุฏูู
$format->setKiloBitrate(1000);  // 1000 = ุฌูุฏุฉ ูุชูุณุทุฉ
$format->setAudioKiloBitrate(128);

// ุงูุฎูุงุฑุงุช:
// 500   = ุตุบูุฑ ุฌุฏุงูุ ุฌูุฏุฉ ููุฎูุถุฉ
// 1000  = ูุชูุณุท โญ (ููุตู ุจู)
// 2000  = ูุจูุฑุ ุฌูุฏุฉ ุนุงููุฉ
// 5000  = ูุจูุฑ ุฌุฏุงูุ ุฌูุฏุฉ ุนุงููุฉ ุฌุฏุงู
```

```php
// ููุตูุช
$format->setAudioKiloBitrate(128);  // 128 = ุฌูุฏุฉ ูุชูุณุทุฉ

// ุงูุฎูุงุฑุงุช:
// 64   = ุตุบูุฑุ ุฌูุฏุฉ ููุฎูุถุฉ
// 128  = ูุชูุณุท โญ (ููุตู ุจู)
// 192  = ูุจูุฑุ ุฌูุฏุฉ ุนุงููุฉ
// 320  = ูุจูุฑ ุฌุฏุงูุ ุฌูุฏุฉ ุนุงููุฉ ุฌุฏุงู
```

---

## ๐ ููุงุฑูุฉ ุงูุณููุงุฑูููุงุช

| ุงูููุฒุฉ              | ุจุฏูู Queue | Queue ุจุฏูู ุถุบุท | Queue + ุถุบุท    |
| ------------------- | ---------- | -------------- | -------------- |
| **ุงูุฑูุน**           | โ ูุนูู    | โ ูุนูู        | โ ูุนูู        |
| **Progress Bar**    | โ         | โ             | โ             |
| **ุงููุณุชุฎุฏู ููุชุธุฑุ** | โ ูุนู     | โ ูุง          | โ ูุง          |
| **ูุนุงูุฌุฉ ุฎูููุฉ**    | โ         | โ             | โ             |
| **ุชุตุบูุฑ ุงูุญุฌู**     | โ         | โ             | โ 400MBโ80MB  |
| **ูุชุทูุจุงุช**         | ูุง ุดูุก     | Queue tables   | Queue + FFmpeg |
| **ุณูููุฉ**           | โญโญโญ     | โญโญ           | โญ             |

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### **1. ุชุญูู ูู Queue:**

```bash
# ุดูู ุงูุฌุฏุงูู
php artisan tinker
> \App\Models\Job::count();  // ุนุฏุฏ ุงูููุงู ุงูููุชุธุฑุฉ
```

### **2. ุชุญูู ูู FFmpeg:**

```bash
# Windows
where ffmpeg

# Linux
which ffmpeg
```

### **3. ุฌุฑูุจ ูุฏููุงู:**

```bash
php artisan tinker
> \App\Jobs\ProcessMediaFile::dispatch(1, '/uploads/videos/test.mp4', 'video', false);
> exit

# ุดูู ุงูู logs
tail -f storage/logs/laravel.log
```

---

## ๐ Logs ููุฑุงูุจุฉ

### **ุดูู ูุงุฐุง ูุญุฏุซ:**

ูู `storage/logs/laravel.log`:

```
[2024-01-31 18:00:00] local.INFO: ุจุฏุก ูุนุงูุฌุฉ video ููููุดูุฑ 123
[2024-01-31 18:00:01] local.INFO: FFmpeg ูุชููุฑ. ุจุฏุก ุงูุถุบุท...
[2024-01-31 18:05:30] local.INFO: ุชู ุถุบุท ุงูููุฏูู: /uploads/videos/video_compressed.mp4
[2024-01-31 18:05:31] local.INFO: ุชู ุถุบุท video ุจูุฌุงุญ ููููุดูุฑ 123
```

ุฃู ุฅุฐุง FFmpeg ุบูุฑ ููุฌูุฏ:

```
[2024-01-31 18:00:00] local.INFO: ุจุฏุก ูุนุงูุฌุฉ video ููููุดูุฑ 123
[2024-01-31 18:00:01] local.INFO: FFmpeg ุบูุฑ ูุชููุฑ. ุชุฎุทู ุงูุถุบุท ููููุดูุฑ 123
```

---

## ๐ฅ ุงูุณููุงุฑูู ุงูููุตู ุจู

### **ููุจุฏุงูุฉ (ุงูุขู):**

โ **ุจุฏูู Queue**

- ูุง ุชุญุชุงุฌ ุชุซุจูุช ุดูุก
- ูู ุดูุก ูุนูู ูุจุงุดุฑุฉ
- Progress Bar ููุฌูุฏ

### **ุจุนุฏ ุงูุฅุทูุงู (ุฅุฐุง ุงููููุน ูุจุฑ):**

โ **Queue ุจุฏูู ุถุบุท**

- ุงููุณุชุฎุฏููู ูุง ููุชุธุฑูู
- ุณูู ุงูุชุซุจูุช
- ูุง ูุญุชุงุฌ FFmpeg

### **ุฅุฐุง ุงููููุงุช ูุจูุฑุฉ ุฌุฏุงู:**

โ **Queue + ุถุบุท**

- ุชูููุฑ Bandwidth
- ุชุญููู ุฃุณุฑุน ููุฒูุงุฑ
- ูุญุชุงุฌ FFmpeg

---

## ๐ก ูุตุงุฆุญ ูููุฉ

### **1. Hostinger Shared Hosting:**

- โ Queue ูุดุชุบู ุจู Cron Job
- โ FFmpeg ุบุงูุจุงู **ุบูุฑ ููุฌูุฏ**
- ๐ ุงุทูุจ ูู ุงูุฏุนู ุชุซุจูุชู

### **2. VPS/Dedicated:**

- โ ูู ุดูุก ูุดุชุบู
- โ FFmpeg ูููู ุชุซุจูุชู ุจุณูููุฉ
- โ Queue Worker ูุดุชุบู daemon

### **3. ุงูุจุฏูู ููุถุบุท:**

- ุงุณุชุฎุฏู ุฎุฏูุฉ ุฎุงุฑุฌูุฉ ูุซู Cloudinary
- ุฃู ุงุทูุจ ูู ุงููุณุชุฎุฏููู ุฑูุน ูููุงุช ูุถุบูุทุฉ

---

## ๐ ุงููููุงุช ุฐุงุช ุงูุนูุงูุฉ

```
app/Jobs/ProcessMediaFile.php     โ ุงูู Job ููุณู (ูุญุณูู)
app/Http/Controllers/
  PostController.php              โ ุงุณุชุฎุฏู dispatch() ููุง
.env                              โ QUEUE_CONNECTION=database
config/queue.php                  โ ุฅุนุฏุงุฏุงุช Queue
storage/logs/laravel.log          โ ุฑุงูุจ ููุง
```

---

## โ ุงูุฎูุงุตุฉ

### **ProcessMediaFile.php ุงูุขู:**

| โ ูุนูู ูู ุงูุชุทููุฑ ูุงูุฅูุชุงุฌ |
| โ ูุชุญูู ูู FFmpeg ุชููุงุฆูุงู |
| โ ูุถุบุท ุฅุฐุง FFmpeg ููุฌูุฏ |
| โ ูุฎุทู ุงูุถุบุท ุฅุฐุง FFmpeg ุบูุฑ ููุฌูุฏ |
| โ ูุฏุนู Windows ู Linux |
| โ ูุง ูุญุชุงุฌ ุฅุนุฏุงุฏุงุช ูุนูุฏุฉ |

### **ููุงุณุชุฎุฏุงู:**

1. ุบููุฑ `QUEUE_CONNECTION=database` ูู `.env`
2. ููุฐ `php artisan queue:table && migrate`
3. ุดุบูู `php artisan queue:work` (ุฃู Cron Job ุนูู Hostinger)
4. ุงุณุชุฎุฏู `dispatch()` ูู Controller

### **FFmpeg (ุงุฎุชูุงุฑู):**

- ููุฌูุฏ โ ุถุบุท ุชููุงุฆู โ
- ุบูุฑ ููุฌูุฏ โ ูุดุชุบู ุนุงุฏู โ

**๐ ุงูููู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูู ุฃู ุจูุฆุฉ!**
